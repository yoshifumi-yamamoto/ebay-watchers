<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
     <form onsubmit="sendData()">
      <p>
        ファイル：<input id="file" type="file" name="file" onchange="fileChange(this)" />
      </p>
      <script>
        function fileChange(e){
          console.log('fileChange')
          console.log({e:e})
          if (e.files[0]['type'].indexOf('csv') !== -1 && e.files[0]['size'] < 1000000) {
            e.parentNode.parentNode.send.disabled = false;
          } else {
            alert('適切なファイルをアップロードしてください。');
            e.value = '';
          }
        }

        function sendData(){
          // e.disabled = true;
          // console.log('e.file')
          // console.log(e.file.files)
          // google.script.run.sendForm(e.file.files);
          const f = document.getElementById('file');
          [...f.files].forEach((file, i) => {
            const fr = new FileReader();
            fr.onload = (e) => {
              console.log("onload")
              const data = e.target.result.split(",");
              const obj = {fileName: f.files[i].name, mimeType: data[0].match(/:(\w.+);/)[1], data: data[1]};
              google.script.run.withSuccessHandler((id) => {
                console.log('id');
                console.log(id);
              }).sendForm(obj);
            }
            fr.readAsDataURL(file);
          });
        }
      </script>
      <button type="submit"  disabled=true name="send">
        ファイルをアップロードする
      </button>
    </form>
  </body>
</html>
